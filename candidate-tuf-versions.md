* TAP:
* Title: Managing TUF Versions
* Version: 1
* Last-Modified: 04-July-2018
* Author: Marina Moore, Justin Cappos
* Status: Draft
* Content-Type: text/markdown
* Created: 19-December-2018

# Abstract

This TAP clarifies how to manage updates to the TUF specification that include non-backwards compatible (breaking) changes. A breaking change means that a client and repository must implement the change at the same time in order to continue functioning as expected. To facilitate finding breaking changes, this TAP defines a procedure for TUF clients to ensure that their version of the TUF specification is compatible with the specification version of the metadata they download. This TAP allows clients to update from their current version of the TUF specification to a version that is not backwards compatible.

# Motivation

The goal of this TAP is to prevent compatibility issues while allowing breaking changes to the TUF specification. Various TAPs, including TAPs 3 and 8 include changes that are not backwards compatible. That means that metadata generated by a repository using a new version of the specification will be incompatible with clients using the old version of the specification. Similarly, clients using the new version will no longer be able to parse metadata from repositories using the old version of the specification. Because of this, clients need to check that the version of the specification that they are using is compatible with the version that a repository is using before validating metadata.

# Rationale

In order to allow for breaking changes, a client must compare its spec-version to the spec-version of the repository then report and error or update the client if these versions are not compatible. To allow for this functionality, this TAP clarifies how spec-versions should be formatted, defines a procedure for comparing versions, and describes how root metadata can be updated.

This TAP clarifies that the spec-versions field of root metadata shall be based on [Semantic Versioning](https://semver.org/), with version numbers in the format MAJOR.MINOR.PATCH. This is a standard format used in other open source projects, and makes the version numbers consistent and easily understood. In accordance with Semantic Versioning, breaking changes will only occur during a major release of the TUF spec (e.g. 1.x.x to 2.x.x). The Backwards Compatibility section of a TAP should be used to determine whether the TAP creates a breaking change. If the change is not backwards compatible, then it will be part of a new major version. Non backwards compatible versions add features that change the way that TUF processes updates, and need to be implemented on both the client and repository to maintain security and functionality. Examples of breaking changes are TAP 3 and TAP 8. If the change adds a new feature that is backwards compatible, for example in TAP 4 and TAP 10, it is not a breaking change and should be part of a new minor version. Patches are used to fix typos and make small changes to existing features. More details about what constitutes a major, minor, or patch change can be found at https://semver.org/.

The consistent format of versions makes it possible for clients to reliably compare the spec version that they are using to the spec version found in TUF metadata. To do this comparison, the client will check the major version in the root metadata when the root metadata is downloaded. If a new major version is found the client must update to the new spec-version before performing any software updates. This ensures that the client and metadata are using the same version number before validation.

As the client checks the metadata spec-version in the root metadata, the root metadata format will not be altered before this check takes place. In order to allow for updates to the root metadata format, an intermediate root metadata file will be created when the root metadata is updated. Root metadata updates will only occur as part of a major version. The intermediate root metadata file will contain the new spec-version, but will be formatted according to the old specification. After a client downloads the intermediate root metadata and updates to the new spec-version, they will download the root metadata file that follows the intermediate one, and continue with the update. If a client is multiple versions behind a repository, they will be able to access the root metadata files for each version during the root metadata download process. This will occur while the client is validating each of the root metadata files in the chain. The client already downloads root metadata until the most recent is found, so the intermediate root metadata will not be used to validate updates.

# Specification

This TAP requires some setup on the client to ensure that the spec-versions are compatible before an update is performed. In addition, the repository needs to perform some configuration when the spec-version is updated. These processes are described in this section.

## Client Setup

The following steps must be implemented in the setup of a TUF client:

* The client must keep track of its version of the TUF specification. To do so, a global variable or other local storage option should contain the client spec-version. For simplicity, this field should be formatted according to Semantic Versioning so that it can be directly compared to the spec-version in root metadata.

* The root metadata already contains the TUF spec-version. After downloading and verifying the root metadata, the client shall compare the spec-version in the root metadata (repository spec-version) with the spec-version of the local client (client spec-version). The client shall then proceed as described in [Procedure](#procedure).

### Procedure

When the client compares their spec-version to the spec-version found in the root metadata, there are a few possible cases. If the versions are the same, nothing needs to be done. If the major versions differ, the update halts and cannot be completed until the major versions match. If the major versions match but the minor or patch versions differ, the client may choose to continue the update or to update to a new client. These cases are discussed in detail below.

If the major versions on the client and repository do not match, the update cannot proceed until this discrepancy is resolved. If the repository spec-version is lower than the client spec-version, the client should terminate and report the mismatch to the user. The client's user may then choose to report this issue to the repository or take no action. The client will not be able to perform an update until the repository is updated or the client chooses to downgrade their TUF client. If the client spec-version is lower than the repository spec-version, the client should try to automatically update to a new TUF client. If an updated client is not available, the client shall report the mismatch to the user so that the user may manually update the client. Once the updated TUF client is installed, the client should proceed with the update.

If a minor version or patch of the spec-version does not match, the client should report the mismatch to the user. However, the update can proceed without further action. A client may choose to update before proceeding with the update or simply log the error. Additionally, a client may act differently for minor version changes and patches. For example, a client may choose to require manual confirmation before proceeding with a mismatched minor version, but automatically continue with a mismatched patch.

## How a Repository updates to a new spec-version

If there are no changes to the root metadata format or metadata encoding, the repository simply creates and signs a new root metadata file that includes the new spec-version. If the root metadata format changes in any way, the repository must create two root metadata files. The first is formatted using the old specification, but includes the new spec-version. The second Is formatted using the new specification and the new spec-version. All other metadata files and images are handled as described in the specification.

## Changes to TAPs
TAPs shall be tied to a version of the TUF specification. Once a TAP is accepted the header should be updated to include the first TUF version that will include the TAP. The Preamble Header description in TAP 1 shall be updated to include this field.

## Version Number format

TUF version numbers shall be determined based on [semantic versioning](https://semver.org/). This specification describes version numbers in the format MAJOR.MINOR.PATCH. In semantic versioning, only major changes are non-backwards compatible.

## Multiple Repositories
If a client downloads metadata from multiple repositories as described in [TAP 4](https://github.com/theupdateframework/taps/blob/master/tap4.md), the client should check that the major version on all repositories and the client is the same. If any of the major versions do not match, the mismatch should be handled as discussed in [Procedure](#procedure). The client should not maintain multiple spec-versions for different repositories as this prevents the metadata from different repositories from being compared.

## Updating Trusted Root Metadata
After a major version change, the client must update their trusted root metadata to the root metadata that complies with the new spec-version. To do so, the client first downloads and verifies the intermediate root metadata file, then downloads and verifies the current version root metadata file. Once verified, this current version root metadata file must be stored as the trusted root metadata. In future updates, the client will start from the trusted root metadata when finding the next available update.

# Security Analysis

There should be minimal security impact. Ensuring that the client is up to date should improve security in the event that a security vulnerability is patched in a release of the spec.

# Backwards Compatibility

This TAP is backwards compatible, and should be implemented on all clients before any non-backwards compatible TAPs are released.

# Augmented Reference Implementation

This TAP is included in the reference implementation [here] (https://github.com/theupdateframework/tuf/pull/854).

# Copyright

This document has been placed in the public domain.
